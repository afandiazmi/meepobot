<!DOCTYPE html>
<html lang="en">
  <head>
    <title>MEEPOBOT Web Remote</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <script src="{{ url_for('static', filename='tailwind.js') }}"></script>
    <link
      href="{{ url_for('static', filename='materialdesignicons.css') }}"
      rel="stylesheet" />
    <style>
      /* Base Settings */
      body {
        font-family: "Inter", ui-sans-serif, system-ui, -apple-system,
          sans-serif;
        overflow: hidden; /* Prevent body scroll */
        height: 100vh;
        background-color: #f8fafc; /* Light Gray Background */
        color: #1e293b; /* Dark text */
      }

      /* Custom Scrollbar for internal panels */
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }

      /* D-Pad Styling */
      .dpad-button {
        width: 65px;
        height: 65px;
        font-size: 24px;
        border-radius: 1rem; /* Squircle */
        transition: transform 0.1s, box-shadow 0.1s;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .dpad-button:active {
        transform: scale(0.95);
        box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.1);
      }

      /* Tab Navigation (Segmented Control Style) */
      .nav-container {
        background-color: #e2e8f0;
        border-radius: 0.75rem;
        padding: 0.25rem;
      }
      .nav-tab {
        border-radius: 0.5rem;
        font-weight: 600;
        font-size: 0.8rem;
        color: #64748b;
        transition: all 0.2s ease;
        border: 1px solid transparent;
      }
      .nav-tab:hover {
        color: #334155;
      }
      .active-tab {
        background-color: #ffffff;
        color: #2563eb; /* Blue-600 */
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1),
          0 1px 2px 0 rgba(0, 0, 0, 0.06);
      }

      /* Blockly Overrides for Light Mode */
      #blocklyDiv {
        height: 100%;
        min-height: 300px;
        width: 100%;
      }
      .blocklySvg {
        background-color: #ffffff !important;
        border-radius: 0.5rem;
      }
      .blocklyToolboxDiv {
        background-color: #f1f5f9 !important; /* Slate-100 */
        border-right: 1px solid #e2e8f0;
      }
      .blocklyTreeLabel {
        color: #334155 !important;
      }
      /* Hide Blockly scrollbars */
      .blocklyScrollbarVertical,
      .blocklyFlyoutScrollbar {
        display: none !important;
      }

      /* Fullscreen logic */
      .fullscreen-blockly {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 9999;
        background-color: #ffffff;
        padding: 10px;
      }

      /* Utilities */
      .glass-panel {
        background: white;
        border: 1px solid #e2e8f0;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05),
          0 2px 4px -2px rgba(0, 0, 0, 0.05);
      }

      /* Make video responsive within container without stretching */
      .video-container img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        background: #000;
        border-radius: 0.5rem;
      }
    </style>
  </head>
  <body class="flex flex-col h-screen">
    <header
      class="flex-none bg-white border-b border-gray-200 px-4 py-3 shadow-sm z-10 flex justify-between items-center">
      <div class="flex items-center gap-2">
        <div class="bg-blue-600 text-white p-1 rounded-md">
          <span class="mdi mdi-robot text-xl"></span>
        </div>
        <h1 class="text-xl font-bold text-gray-800 tracking-tight">MEEPOBOT</h1>
      </div>

      <div
        class="flex items-center gap-2 bg-gray-100 rounded-full px-4 py-1.5 border border-gray-200">
        <span
          class="text-xs font-semibold text-gray-500 uppercase tracking-wide"
          >Status</span
        >
        <span
          id="robot-mode"
          class="text-sm font-bold text-red-500 transition-colors"
          >STOP</span
        >
      </div>
    </header>

    <div
      class="flex-1 flex flex-col md:flex-row overflow-hidden p-2 md:p-4 gap-3">
      <div class="flex-none md:flex-1 h-[35vh] md:h-auto flex flex-col gap-3">
        <div
          class="flex-1 glass-panel rounded-xl p-2 video-container relative overflow-hidden">
          <img
            id="video-feed"
            src="{{ url_for('video_feed') }}"
            alt="Robot Camera Feed" />
          <div
            class="absolute top-3 left-3 bg-black/50 text-white text-xs px-2 py-1 rounded backdrop-blur-sm">
            <span class="mdi mdi-camera"></span> LIVE
          </div>
        </div>

        <button
          onclick="setMode('STOP')"
          class="flex-none bg-red-500 hover:bg-red-600 active:bg-red-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg shadow-red-500/30 transition-all flex items-center justify-center gap-2 text-lg">
          <span class="mdi mdi-octagon-alert"></span> STOP ALL MOTORS
        </button>
      </div>

      <div
        class="flex-1 md:w-2/3 flex flex-col glass-panel rounded-xl overflow-hidden">
        <nav class="flex-none p-3 border-b border-gray-100">
          <div
            id="nav-tabs"
            class="nav-container flex flex-wrap justify-between gap-1">
            <button
              onclick="showSection('manual-drive')"
              class="nav-tab active-tab flex-1 py-2">
              Manual
            </button>
            <button
              onclick="showSection('sequential-prog')"
              class="nav-tab flex-1 py-2">
              Blockly
            </button>
            <button
              onclick="showSection('face-track')"
              class="nav-tab flex-1 py-2">
              Face
            </button>
            <button
              onclick="showSection('line-follow')"
              class="nav-tab flex-1 py-2">
              Line
            </button>
          </div>
        </nav>

        <main class="flex-1 relative overflow-y-auto bg-white">
          <section
            id="manual-drive"
            class="h-full flex flex-col items-center justify-center p-4">
            <div class="w-full max-w-sm">
              <div class="grid grid-cols-3 gap-3 mb-6 justify-items-center">
                <div class="col-start-2">
                  <button
                    onmousedown="sendManualCommand('forward')"
                    ontouchstart="sendManualCommand('forward', event)"
                    onmouseup="sendManualCommand('stop')"
                    ontouchend="sendManualCommand('stop', event)"
                    class="dpad-button bg-blue-100 text-blue-600 border border-blue-200 hover:bg-blue-500 hover:text-white">
                    <span class="mdi mdi-arrow-up-thick"></span>
                  </button>
                </div>

                <div class="col-start-1">
                  <button
                    onmousedown="sendManualCommand('left')"
                    ontouchstart="sendManualCommand('left', event)"
                    onmouseup="sendManualCommand('stop')"
                    ontouchend="sendManualCommand('stop', event)"
                    class="dpad-button bg-blue-100 text-blue-600 border border-blue-200 hover:bg-blue-500 hover:text-white">
                    <span class="mdi mdi-arrow-left-thick"></span>
                  </button>
                </div>

                <div class="col-start-2 flex items-center justify-center">
                  <div
                    class="w-16 h-16 rounded-full bg-gray-100 border border-gray-200 flex items-center justify-center">
                    <span
                      class="mdi mdi-gamepad-variant text-gray-400 text-2xl"></span>
                  </div>
                </div>

                <div class="col-start-3">
                  <button
                    onmousedown="sendManualCommand('right')"
                    ontouchstart="sendManualCommand('right', event)"
                    onmouseup="sendManualCommand('stop')"
                    ontouchend="sendManualCommand('stop', event)"
                    class="dpad-button bg-blue-100 text-blue-600 border border-blue-200 hover:bg-blue-500 hover:text-white">
                    <span class="mdi mdi-arrow-right-thick"></span>
                  </button>
                </div>

                <div class="col-start-2">
                  <button
                    onmousedown="sendManualCommand('backward')"
                    ontouchstart="sendManualCommand('backward', event)"
                    onmouseup="sendManualCommand('stop')"
                    ontouchend="sendManualCommand('stop', event)"
                    class="dpad-button bg-blue-100 text-blue-600 border border-blue-200 hover:bg-blue-500 hover:text-white">
                    <span class="mdi mdi-arrow-down-thick"></span>
                  </button>
                </div>
              </div>

              <div
                class="bg-gray-50 rounded-xl p-3 border border-gray-100 flex justify-around">
                <div class="text-center">
                  <p class="text-[10px] uppercase font-bold text-gray-400 mb-1">
                    Pan (Base)
                  </p>
                  <div class="flex gap-1">
                    <button
                      onclick="sendServoCommand('pan', 'increment')"
                      class="bg-white hover:bg-gray-100 border px-3 py-1 rounded text-gray-600 shadow-sm">
                      <span class="mdi mdi-chevron-left"></span>
                    </button>
                    <button
                      onclick="sendServoCommand('pan', 'decrement')"
                      class="bg-white hover:bg-gray-100 border px-3 py-1 rounded text-gray-600 shadow-sm">
                      <span class="mdi mdi-chevron-right"></span>
                    </button>
                  </div>
                </div>
                <div class="w-px bg-gray-200"></div>
                <div class="text-center">
                  <p class="text-[10px] uppercase font-bold text-gray-400 mb-1">
                    Tilt (Head)
                  </p>
                  <div class="flex gap-1">
                    <button
                      onclick="sendServoCommand('tilt', 'decrement')"
                      class="bg-white hover:bg-gray-100 border px-3 py-1 rounded text-gray-600 shadow-sm">
                      <span class="mdi mdi-chevron-up"></span>
                    </button>
                    <button
                      onclick="sendServoCommand('tilt', 'increment')"
                      class="bg-white hover:bg-gray-100 border px-3 py-1 rounded text-gray-600 shadow-sm">
                      <span class="mdi mdi-chevron-down"></span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <section id="sequential-prog" class="hidden h-full flex flex-col p-2">
            <div class="flex justify-between items-center mb-2 px-1">
              <h2 class="text-sm font-bold text-gray-700">Sequence Builder</h2>
              <button
                id="toggle-fullscreen"
                onclick="toggleFullscreen()"
                class="text-xs text-blue-600 font-semibold flex items-center hover:bg-blue-50 px-2 py-1 rounded">
                <span
                  id="fullscreen-icon"
                  class="mdi mdi-fullscreen mr-1"></span>
                Expand
              </button>
            </div>

            <div
              class="flex-1 border border-gray-200 rounded-lg overflow-hidden bg-white shadow-inner mb-3">
              <div id="blocklyDiv"></div>
            </div>

            <div
              class="flex-none flex flex-col sm:flex-row gap-2 items-center bg-gray-50 p-3 rounded-lg border border-gray-100">
              <button
                onclick="runBlocklyInstructions()"
                class="w-full sm:w-auto bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg shadow-md transition-colors flex items-center justify-center gap-2">
                <span class="mdi mdi-play"></span> Run Sequence
              </button>
              <span
                id="seq-status"
                class="text-xs font-medium text-gray-500 ml-2"
                >Ready to program</span
              >
            </div>
            <textarea id="generated_instructions" class="hidden"></textarea>
          </section>

          <section
            id="face-track"
            class="hidden h-full flex flex-col items-center justify-center p-6 text-center">
            <div class="bg-blue-50 rounded-full p-6 mb-4">
              <span
                class="mdi mdi-face-recognition text-6xl text-blue-500"></span>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">
              Face Tracking Mode
            </h3>
            <p class="text-gray-500 mb-8 max-w-md">
              The robot will autonomously scan the environment. When a face is
              detected, it will align its camera and move to maintain a set
              distance.
            </p>
            <button
              onclick="setMode('FACE_TRACK')"
              class="w-full max-w-xs bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg shadow-blue-500/30 transition-all flex items-center justify-center gap-2">
              <span class="mdi mdi-eye"></span> Activate Tracking
            </button>
          </section>

          <section id="line-follow" class="hidden h-full flex flex-col p-4">
            <div class="text-center mb-4">
              <h3 class="text-lg font-bold text-gray-800">
                Line Follow Configuration
              </h3>
              <p class="text-sm text-gray-500">Select the track color below</p>
            </div>

            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-6">
              <button
                onclick="setLineColor('black')"
                class="h-16 rounded-xl border-2 border-transparent hover:border-gray-300 bg-gray-900 text-white font-medium shadow-sm transition-all">
                Black
              </button>
              <button
                onclick="setLineColor('white')"
                class="h-16 rounded-xl border-2 border-gray-200 hover:border-gray-300 bg-white text-gray-800 font-medium shadow-sm transition-all">
                White
              </button>
              <button
                onclick="setLineColor('red')"
                class="h-16 rounded-xl border-2 border-transparent hover:border-red-200 bg-red-500 text-white font-medium shadow-sm shadow-red-200 transition-all">
                Red
              </button>
              <button
                onclick="setLineColor('blue')"
                class="h-16 rounded-xl border-2 border-transparent hover:border-blue-200 bg-blue-600 text-white font-medium shadow-sm shadow-blue-200 transition-all">
                Blue
              </button>
              <button
                onclick="setLineColor('green')"
                class="h-16 rounded-xl border-2 border-transparent hover:border-green-200 bg-green-600 text-white font-medium shadow-sm shadow-green-200 transition-all">
                Green
              </button>
              <button
                onclick="setLineColor('yellow')"
                class="h-16 rounded-xl border-2 border-transparent hover:border-yellow-200 bg-yellow-400 text-yellow-900 font-medium shadow-sm shadow-yellow-200 transition-all">
                Yellow
              </button>
            </div>

            <div
              id="color-status"
              class="text-center text-sm font-medium h-6 mb-4"></div>

            <div class="mt-auto">
              <button
                onclick="setMode('LINE_FOLLOW')"
                class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg shadow-orange-500/30 transition-all flex items-center justify-center gap-2">
                <span class="mdi mdi-road-variant"></span> Start Autonomous
                Drive
              </button>
            </div>
          </section>
        </main>
      </div>
    </div>

    <script src="{{ url_for('static', filename='blockly/blockly_compressed.js') }}"></script>
    <script src="{{ url_for('static', filename='blockly/blocks_compressed.js') }}"></script>
    <script src="{{ url_for('static', filename='blockly/javascript_compressed.js') }}"></script>
    <script src="{{ url_for('static', filename='blockly/msg/js/en.js') }}"></script>
    <script>
      // ---------------------------------------------------------
      // JAVASCRIPT LOGIC (PRESERVED)
      // ---------------------------------------------------------
      const javascriptGenerator = Blockly.JavaScript;

      Blockly.Blocks["robot_forward"] = {
        init: function () {
          this.appendDummyInput().appendField("Move Forward for");
          this.appendValueInput("DURATION").setCheck("Number");
          this.appendDummyInput().appendField("seconds");
          this.setPreviousStatement(true, null);
          this.setNextStatement(true, null);
          this.setColour(210); // Changed color for light theme contrast
          this.setTooltip("Move robot forward");
          this.setHelpUrl("");
        },
      };

      Blockly.Blocks["robot_backward"] = {
        init: function () {
          this.appendDummyInput().appendField("Move Backward for");
          this.appendValueInput("DURATION").setCheck("Number");
          this.appendDummyInput().appendField("seconds");
          this.setPreviousStatement(true, null);
          this.setNextStatement(true, null);
          this.setColour(210);
          this.setTooltip("Move robot backward");
          this.setHelpUrl("");
        },
      };

      Blockly.Blocks["robot_left"] = {
        init: function () {
          this.appendDummyInput().appendField("Turn Left for");
          this.appendValueInput("DURATION").setCheck("Number");
          this.appendDummyInput().appendField("seconds");
          this.setPreviousStatement(true, null);
          this.setNextStatement(true, null);
          this.setColour(160);
          this.setTooltip("Turn robot left");
          this.setHelpUrl("");
        },
      };

      Blockly.Blocks["robot_right"] = {
        init: function () {
          this.appendDummyInput().appendField("Turn Right for");
          this.appendValueInput("DURATION").setCheck("Number");
          this.appendDummyInput().appendField("seconds");
          this.setPreviousStatement(true, null);
          this.setNextStatement(true, null);
          this.setColour(160);
          this.setTooltip("Turn robot right");
          this.setHelpUrl("");
        },
      };

      Blockly.Blocks["robot_stop"] = {
        init: function () {
          this.appendDummyInput().appendField("Stop for");
          this.appendValueInput("DURATION").setCheck("Number");
          this.appendDummyInput().appendField("seconds");
          this.setPreviousStatement(true, null);
          this.setNextStatement(true, null);
          this.setColour(0);
          this.setTooltip("Stop robot movement");
          this.setHelpUrl("");
        },
      };

      javascriptGenerator.forBlock["robot_forward"] = function (
        block,
        generator
      ) {
        const duration =
          generator.valueToCode(
            block,
            "DURATION",
            javascriptGenerator.ORDER_ATOMIC
          ) || "1";
        return "t_up:" + duration + ";\n";
      };

      javascriptGenerator.forBlock["robot_backward"] = function (
        block,
        generator
      ) {
        const duration =
          generator.valueToCode(
            block,
            "DURATION",
            javascriptGenerator.ORDER_ATOMIC
          ) || "1";
        return "t_down:" + duration + ";\n";
      };

      javascriptGenerator.forBlock["robot_left"] = function (block, generator) {
        const duration =
          generator.valueToCode(
            block,
            "DURATION",
            javascriptGenerator.ORDER_ATOMIC
          ) || "1";
        return "turnLeft:" + duration + ";\n";
      };

      javascriptGenerator.forBlock["robot_right"] = function (
        block,
        generator
      ) {
        const duration =
          generator.valueToCode(
            block,
            "DURATION",
            javascriptGenerator.ORDER_ATOMIC
          ) || "1";
        return "turnRight:" + duration + ";\n";
      };

      javascriptGenerator.forBlock["robot_stop"] = function (block, generator) {
        const duration =
          generator.valueToCode(
            block,
            "DURATION",
            javascriptGenerator.ORDER_ATOMIC
          ) || "0";
        return "t_stop:" + duration + ";\n";
      };

      const toolboxXml = `
        <xml id="toolbox" style="display: none">
          <category name="Movement" colour="210">
            <block type="robot_forward">
              <value name="DURATION"><shadow type="math_number"><field name="NUM">2</field></shadow></value>
            </block>
            <block type="robot_backward">
              <value name="DURATION"><shadow type="math_number"><field name="NUM">2</field></shadow></value>
            </block>
            <block type="robot_left">
              <value name="DURATION"><shadow type="math_number"><field name="NUM">1</field></shadow></value>
            </block>
            <block type="robot_right">
              <value name="DURATION"><shadow type="math_number"><field name="NUM">1</field></shadow></value>
            </block>
            <block type="robot_stop">
              <value name="DURATION"><shadow type="math_number"><field name="NUM">1</field></shadow></value>
            </block>
          </category>
          <category name="Loops" colour="120">
            <block type="controls_repeat_ext">
              <value name="TIMES"><shadow type="math_number"><field name="NUM">3</field></shadow></value>
            </block>
          </category>
          <category name="Math" colour="230">
            <block type="math_number"><field name="NUM">1</field></block>
            <block type="math_arithmetic">
              <field name="OP">ADD</field>
              <value name="A"><shadow type="math_number"><field name="NUM">1</field></shadow></value>
              <value name="B"><shadow type="math_number"><field name="NUM">1</field></shadow></value>
            </block>
          </category>
        </xml>
      `;

      let workspace = null;

      function showSection(sectionId) {
        document.querySelectorAll("main section").forEach((section) => {
          section.classList.add("hidden");
        });
        document.getElementById(sectionId).classList.remove("hidden");

        document.querySelectorAll(".nav-tab").forEach((tab) => {
          tab.classList.remove("active-tab");
          if (tab.innerText.toLowerCase().includes(sectionId.split("-")[0])) {
            tab.classList.add("active-tab");
          }
        });

        if (sectionId === "sequential-prog") {
          // Slight delay to ensure DOM is visible for Blockly injection sizing
          setTimeout(() => {
            if (!workspace) {
              initBlockly();
            } else {
              Blockly.svgResize(workspace);
            }
          }, 10);
        }
      }

      function toggleFullscreen() {
        const section = document.getElementById("sequential-prog");
        const icon = document.getElementById("fullscreen-icon");
        const btn = document.getElementById("toggle-fullscreen");

        if (section.classList.contains("fullscreen-blockly")) {
          section.classList.remove("fullscreen-blockly");
          icon.classList.remove("mdi-fullscreen-exit");
          icon.classList.add("mdi-fullscreen");
          btn.innerHTML =
            '<span id="fullscreen-icon" class="mdi mdi-fullscreen mr-1"></span> Expand';
        } else {
          section.classList.add("fullscreen-blockly");
          icon.classList.remove("mdi-fullscreen");
          icon.classList.add("mdi-fullscreen-exit");
          btn.innerHTML =
            '<span id="fullscreen-icon" class="mdi mdi-fullscreen-exit mr-1"></span> Exit';
        }

        if (workspace) {
          Blockly.svgResize(workspace);
        }
      }

      function updateMode(mode) {
        const modeEl = document.getElementById("robot-mode");
        modeEl.innerText = mode;
        modeEl.classList.remove(
          "text-red-500",
          "text-blue-500",
          "text-orange-500",
          "text-green-500"
        );

        switch (mode) {
          case "STOP":
            modeEl.classList.add("text-red-500");
            break;
          case "FACE_TRACK":
            modeEl.classList.add("text-blue-500");
            break;
          case "LINE_FOLLOW":
            modeEl.classList.add("text-orange-500");
            break;
          case "MANUAL":
          case "SEQUENTIAL":
          default:
            modeEl.classList.add("text-green-500");
        }
      }

      function sendManualCommand(command, event) {
        if (event) {
          event.preventDefault();
        }
        fetch("/manual_control", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ command: command, speed: 50 }),
        })
          .then((response) => response.json())
          .then((data) => updateMode(data.mode))
          .catch((error) => console.error("Error:", error));
      }

      function sendServoCommand(servo, action) {
        fetch("/servo_control", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ servo: servo, action: action }),
        })
          .then((response) => response.json())
          .then((data) => console.log("Servo:", data))
          .catch((error) => console.error("Error:", error));
      }

      function initBlockly() {
        const blocklyDiv = document.getElementById("blocklyDiv");
        const toolbox = toolboxXml;

        // Light Theme Configuration
        workspace = Blockly.inject(blocklyDiv, {
          toolbox: toolbox,
          scrollbars: true,
          trashcan: true,
          horizontalLayout: false,
          grid: { spacing: 20, length: 3, colour: "#cbd5e1", snap: true },
          zoom: {
            controls: true,
            wheel: true,
            startScale: 1.0,
            maxScale: 3,
            minScale: 0.3,
          },
          move: { scrollbars: true, drag: true, wheel: true },
        });

        const xmlText =
          '<xml><block type="robot_forward" x="50" y="50"><value name="DURATION"><shadow type="math_number"><field name="NUM">2</field></shadow></value></block></xml>';
        const xmlDom = Blockly.utils.xml.textToDom(xmlText);
        Blockly.Xml.domToWorkspace(xmlDom, workspace);

        window.addEventListener("resize", function () {
          if (workspace) {
            Blockly.svgResize(workspace);
          }
        });
      }

      function runBlocklyInstructions() {
        if (!workspace) {
          console.error("Workspace not initialized");
          return;
        }

        let code = javascriptGenerator.workspaceToCode(workspace);
        const instruction_list = code
          .split(";")
          .map((s) => s.trim())
          .filter((s) => s.length > 0)
          .join(",");

        document.getElementById("generated_instructions").value =
          instruction_list;
        const statusEl = document.getElementById("seq-status");

        if (!instruction_list) {
          statusEl.innerText = "Error: Workspace is empty.";
          statusEl.className = "text-xs font-bold text-red-500 ml-2";
          return;
        }

        statusEl.innerText = "Sending...";
        statusEl.className = "text-xs font-medium text-yellow-600 ml-2";

        fetch("/run_instructions", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ instructions: instruction_list }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "running") {
              updateMode(data.mode);
              statusEl.innerText = `Running ${data.count} steps...`;
              statusEl.className = "text-xs font-medium text-green-600 ml-2";
            } else {
              statusEl.innerText = data.message;
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            statusEl.innerText = "Failed to send.";
            statusEl.className = "text-xs font-bold text-red-500 ml-2";
          });
      }

      function setMode(mode) {
        fetch("/set_mode", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ mode: mode }),
        })
          .then((response) => response.json())
          .then((data) => {
            updateMode(data.mode);
            if (mode === "FACE_TRACK") showSection("face-track");
            if (mode === "LINE_FOLLOW") showSection("line-follow");
            if (mode === "STOP") showSection("manual-drive");
            if (mode === "SEQUENTIAL") showSection("sequential-prog");
          })
          .catch((error) => console.error("Error:", error));
      }

      function setLineColor(color) {
        fetch("/set_line_color", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ color: color }),
        })
          .then((response) => response.json())
          .then((data) => {
            const statusEl = document.getElementById("color-status");
            if (data.status === "color_set") {
              statusEl.innerText = `✓ Line color set to: ${color.toUpperCase()}`;
              statusEl.className = "text-sm font-bold text-green-600 mb-4 h-6";
            } else {
              statusEl.innerText = `✗ Failed to set color: ${data.message}`;
              statusEl.className = "text-sm font-bold text-red-500 mb-4 h-6";
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            const statusEl = document.getElementById("color-status");
            statusEl.innerText = "✗ Connection error";
            statusEl.className = "text-sm font-bold text-red-500 mb-4 h-6";
          });
      }

      window.onload = function () {
        if (typeof Blockly !== "undefined" && Blockly.inject) {
        } else {
          console.error("Blockly library not found.");
        }
        updateMode("STOP");
        showSection("manual-drive");
      };
    </script>
  </body>
</html>
